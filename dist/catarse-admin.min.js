/*
    A Mithril.js plugin to authenticate requests against PostgREST
    Copyright (c) 2007 - 2015 Diogo Biazus
    Licensed under the MIT license (http://digitalbush.com/projects/masked-input-plugin/#license)
    Version: 1.0.0
*/
var adminApp=window.adminApp={models:{},error:m.prop(),timezone:"America/Sao_Paulo"},momentify=function(a,b){b=b||"DD/MM/YYYY";adminApp.timezone||"America/Sao_Paulo";return a?moment(a).format(b):"no date"},momentFromString=function(a,b){var c=moment(a,b||"DD/MM/YYYY");return c.isValid()?c:moment(a)},generateFormatNumber=function(a,b){return function(c,d,e){if(null==c||void 0==c)return null;var f="\\d(?=(\\d{"+(e||3)+"})+"+(d>0?"\\D":"$")+")",g=c.toFixed(Math.max(0,~~d));return(b?g.replace(".",b):g).replace(new RegExp(f,"g"),"$&"+(a||","))}},formatNumber=generateFormatNumber(".",","),toggleProp=function(a,b){var c=m.prop(a);return c.toggle=function(){c(c()===b?a:b)},c},loader=function(){return m("img[alt='Loader'][src='https://s3.amazonaws.com/catarse.files/loader.gif']")},ContributionDetail=m.postgrest.model("contribution_details",["id","contribution_id","user_id","project_id","reward_id","payment_id","permalink","project_name","project_img","user_name","user_profile_img","email","key","value","installments","installment_value","state","anonymous","payer_email","gateway","gateway_id","gateway_fee","gateway_data","payment_method","project_state","has_rewards","pending_at","paid_at","refused_at","reward_minimum_value","pending_refund_at","refunded_at","created_at","is_second_slip"]);adminApp.models.ContributionDetail=ContributionDetail,adminApp.AdminContributions={controller:function(a){var b=this.listVM=adminApp.ContributionListVM,c=this.filterVM=adminApp.ContributionFilterVM;this.submit=function(){return b.firstPage(c.parameters()).then(null,function(a){adminApp.error(a.message)}),!1}},view:function(a){return[m.component(adminApp.AdminFilter,{form:a.filterVM.formDescriber,submit:a.submit}),adminApp.error()?m(".card.card-error.u-radius.fontweight-bold",adminApp.error()):m.component(adminApp.AdminList,{vm:a.listVM})]}};var vm=adminApp.ContributionFilterVM=m.postgrest.filtersVM({full_text_index:"@@",state:"eq",gateway:"eq",value:"between",created_at:"between"});vm.formDescriber=[{type:"main",data:{vm:vm.full_text_index,placeholder:"Busque por projeto, email, Ids do usuário e do apoio..."}},{type:"dropdown",data:{label:"Com o estado",name:"state",vm:vm.state,options:[{value:"",option:"Qualquer um"},{value:"paid",option:"paid"},{value:"refused",option:"refused"},{value:"pending",option:"pending"},{value:"pending_refund",option:"pending_refund"},{value:"refunded",option:"refunded"},{value:"chargeback",option:"chargeback"},{value:"deleted",option:"deleted"}]}},{type:"dropdown",data:{label:"gateway",name:"gateway",vm:vm.gateway,options:[{value:"",option:"Qualquer um"},{value:"Pagarme",option:"Pagarme"},{value:"MoIP",option:"MoIP"},{value:"PayPal",option:"PayPal"},{value:"Credits",option:"Créditos"}]}},{type:"numberRange",data:{label:"Valores entre",first:vm.value.gte,last:vm.value.lte}},{type:"dateRange",data:{label:"Período do apoio",first:vm.created_at.gte,last:vm.created_at.lte}}],vm.state(""),vm.gateway(""),vm.order({created_at:"desc"}),vm.created_at.lte.toFilter=function(){return momentFromString(vm.created_at.lte()).endOf("day").format("")},vm.created_at.gte.toFilter=function(){return momentFromString(vm.created_at.gte()).format()},vm.full_text_index.toFilter=function(){return replaceDiacritics(vm.full_text_index())},adminApp.ContributionListVM=m.postgrest.paginationVM(adminApp.models.ContributionDetail.getPageWithToken),adminApp.PaymentBadge={view:function(a,b){var c=b.contribution;return m(".fontsize-smallest.fontcolor-secondary.lineheight-tight",[function(){switch(c.payment_method.toLowerCase()){case"boletobancario":return m("span#boleto-detail","");case"cartaodecredito":return m("#creditcard-detail.fontsize-smallest.fontcolor-secondary.lineheight-tight",[c.card_first_digits+"******"+c.card_last_digits,m("br"),c.card_brand+" "+c.installments+"x"])}}()])}},adminApp.AdminDetail={controller:function(a){this.displayRequestRefundDropDown=adminApp.ToggleDiv.toggler(),this.displayRefundDropDown=adminApp.ToggleDiv.toggler(),this.displayTransferContributionDropDown=adminApp.ToggleDiv.toggler(),this.displayChangeRewardDropDown=adminApp.ToggleDiv.toggler(),this.displatAnonDropDown=adminApp.ToggleDiv.toggler()},view:function(a,b){var c=b.contribution;return m("#admin-contribution-detail-box",[m(".divider.u-margintop-20.u-marginbottom-20"),m(".w-row.u-marginbottom-30.w-hidden",[m(".w-col.w-col-2",[m("button.btn.btn-small.btn-terciary",{onclick:a.displayRequestRefundDropDown.toggle},"Pedir reembolso"),m.component(adminApp.ToggleDiv,{display:a.displayRequestRefundDropDown,content:m(".dropdown-list.card.u-radius.dropdown-list-medium.zindex-10[data-ix='display-none-on-load'][id='transfer']",[m(".fontsize-smaller.fontweight-semibold.u-text-center.u-marginbottom-20","Quer efetuar o reembolso?"),m("a.btn.btn-small[href='#']","Solicitar reembolso")])})]),m(".w-col.w-col-2",[m("button.btn.btn-small.btn-terciary",{onclick:a.displayRefundDropDown.toggle},"Estornar"),m.component(adminApp.ToggleDiv,{display:a.displayRefundDropDown,content:m(".dropdown-list.card.u-radius.dropdown-list-medium.zindex-10",[m(".fontsize-smaller.fontweight-semibold.u-text-center.u-marginbottom-20","Quer efetuar o estorno?"),m("a.btn.btn-small[href='#']","Solicitar estorno")])})]),m(".w-col.w-col-2",[m("button.btn.btn-small.btn-terciary.btn-desactivated[href='#']","2a via")]),m(".w-col.w-col-2",[m("button.btn.btn-small.btn-terciary",{onclick:a.displayTransferContributionDropDown.toggle},"Transferir apoio"),m.component(adminApp.ToggleDiv,{display:a.displayTransferContributionDropDown,content:m(".dropdown-list.card.u-radius.dropdown-list-medium.zindex-10",[m(".w-form",[m("form[data-name='Email Form 4'][id='email-form-4'][name='email-form-4']",[m("label[for='name-2']","Id do novo apoiador:"),m("input.w-input.text-field[data-name='Name 2'][id='name-2'][name='name'][placeholder='ex: 129908'][type='text']"),m("input.w-button.btn.btn-small[data-wait='Please wait...'][type='submit'][value='Transferir']")])])])})]),m(".w-col.w-col-2",[m("button.btn.btn-small.btn-terciary",{onclick:a.displayChangeRewardDropDown.toggle},"Trocar recompensa"),m.component(adminApp.ToggleDiv,{display:a.displayChangeRewardDropDown,content:m(".dropdown-list.card.u-radius.dropdown-list-medium.zindex-10[data-ix='display-none-on-load'][id='transfer']",{style:{display:" none"}},[m(".w-form",[m("form[data-name='Email Form 4'][id='email-form-4'][name='email-form-4']",[m(".w-radio",[m("input.w-radio-input[data-name='Radio'][id='radio'][name='radio'][type='radio'][value='Radio']"),m("label.w-form-label[for='radio']","R$ 10")]),m(".w-radio",[m("input.w-radio-input[data-name='Radio 2'][id='radio'][name='radio-2'][type='radio'][value='Radio']"),m("label.w-form-label[for='radio']","R$ 10")]),m(".w-radio",[m("input.w-radio-input[data-name='Radio 2'][id='radio'][name='radio-2'][type='radio'][value='Radio']"),m("label.w-form-label[for='radio']","R$ 10")]),m(".w-radio",[m("input.w-radio-input[data-name='Radio 2'][id='radio'][name='radio-2'][type='radio'][value='Radio']"),m("label.w-form-label[for='radio']","R$ 10")]),m(".w-radio",[m("input.w-radio-input[data-name='Radio 2'][id='radio'][name='radio-2'][type='radio'][value='Radio']"),m("label.w-form-label[for='radio']","R$ 10")])])])])})]),m(".w-col.w-col-2",[m("button.btn.btn-small.btn-terciary",{onclick:a.displatAnonDropDown.toggle},"Anonimato"),m.component(adminApp.ToggleDiv,{display:a.displatAnonDropDown,content:m(".dropdown-list.card.u-radius.dropdown-list-medium.zindex-10",[m(".w-form",[m("form[data-name='Email Form 4'][id='email-form-4'][name='email-form-4']",[m(".w-radio",[m("input.w-radio-input[data-name='Radio'][id='radio'][name='radio'][type='radio'][value='Radio']"),m("label.w-form-label[for='radio']","Anônimo")]),m(".w-radio",[m("input.w-radio-input[data-name='Radio 2'][id='radio'][name='radio-2'][type='radio'][value='Radio']"),m("label.w-form-label[for='radio']","Público")])])])])})])]),m(".w-row.card.card-terciary.u-radius",[m.component(adminApp.AdminTransaction,{contribution:c}),m.component(adminApp.AdminTransactionHistory,{contribution:c}),m(".w-col.w-col-4")])])}},adminApp.AdminFilter={controller:function(){this.toggler=toggleProp(!1,!0)},view:function(a,b){var c=function(a){return{main:m.component(adminApp.filterMain,a),dropdown:m.component(adminApp.filterDropdown,a),numberRange:m.component(adminApp.filterNumberRange,a),dateRange:m.component(adminApp.filterDateRange,a)}},d=_.findWhere(b.form,{type:"main"});return m("#admin-contributions-filter.w-section.page-header",[m(".w-container",[m(".fontsize-larger.u-text-center.u-marginbottom-30","Apoios"),m(".w-form",[m("form",{onsubmit:b.submit},[c(d.data).main,m(".u-marginbottom-20.w-row",m('button.w-col.w-col-12.fontsize-smallest.link-hidden-light[type="button"][style="background: none; border: none; outline: none; text-align: left;"]',{onclick:a.toggler.toggle},"Filtros avançados  >")),a.toggler()?m("#advanced-search.w-row.admin-filters",[_.map(b.form,function(a){return"main"!==a.type?c(a.data)[a.type]:""})]):""])])])])}},adminApp.AdminItem={controller:function(a){this.contribution=a.contribution,this.contribution.user_profile_img=this.contribution.user_profile_img||"/assets/catarse_bootstrap/user.jpg",this.CSSsuccess=".text-success",this.CSSwaiting=".text-waiting",this.CSSrefunded=".text-refunded",this.CSSerror=".text-error",this.paymentDetails=function(){if(this.contribution.gateway=this.contribution.gateway.toLowerCase(),!this.contribution.gateway_data)return!1;switch(this.contribution.gateway){case"moip":return this.contribution.card_first_digits=this.contribution.gateway_data.cartao_bin,this.contribution.card_last_digits=this.contribution.gateway_data.cartao_final,this.contribution.card_brand=this.contribution.gateway_data.cartao_bandeira,this.contribution.installments=this.contribution.gateway_data.parcelas,!0;case"pagarme":return this.contribution.card_first_digits=this.contribution.gateway_data.card_first_digits,this.contribution.card_last_digits=this.contribution.gateway_data.card_last_digits,this.contribution.card_brand=this.contribution.gateway_data.card_brand,this.contribution.installments=this.contribution.gateway_data.installments,!0;default:return!1}},this.stateClass=function(){switch(this.contribution.state){case"paid":return this.CSSsuccess;case"refunded":return this.CSSrefunded;case"pending":return this.CSSwaiting;default:return this.CSSerror}},this.paymentMethodClass=function(){switch(this.contribution.payment_method){case"BoletoBancario":return".fa-barcode";case"CartaoDeCredito":return".fa-credit-card";default:return".fa-question"}},this.displayDetailBox=adminApp.ToggleDiv.toggler()},view:function(a,b){var c=a.contribution;return m(".w-clearfix.card.u-radius.u-marginbottom-20.results-admin-contributions",[m(".w-row",[m(".w-col.w-col-4",[m(".w-row",[m(".w-col.w-col-3.w-col-small-3.u-marginbottom-10",[m("img.user-avatar[src='"+c.user_profile_img+"']")]),m(".w-col.w-col-9.w-col-small-9",[m(".fontweight-semibold.fontsize-smaller.lineheight-tighter.u-marginbottom-10",[m("a.alt-link[target='_blank'][href='/users/"+c.user_id+"']",c.user_name)]),m(".fontsize-smallest","Usuário: "+c.user_id),m(".fontsize-smallest.fontcolor-secondary","Catarse: "+c.email),m(".fontsize-smallest.fontcolor-secondary","Gateway: "+c.payer_email)])])]),m(".w-col.w-col-4",[m(".w-row",[m(".w-col.w-col-3.w-col-small-3.u-marginbottom-10",[m("img.thumb-project.u-radius[src="+c.project_img+"][width=50]")]),m(".w-col.w-col-9.w-col-small-9",[m(".fontweight-semibold.fontsize-smaller.lineheight-tighter.u-marginbottom-10",[m("a.alt-link[target='_blank'][href='/"+c.permalink+"']",c.project_name)]),m(".fontsize-smallest.fontweight-semibold",c.project_state),m(".fontsize-smallest.fontcolor-secondary",momentify(c.project_online_date)+" a "+momentify(c.project_expires_at))])])]),m(".w-col.w-col-2",[m(".fontweight-semibold.lineheight-tighter.u-marginbottom-10.fontsize-small","R$"+c.value),m(".fontsize-smallest.fontcolor-secondary",momentify(c.paid_at,"DD/MM/YYYY HH:mm[h]")),m(".fontsize-smallest",["ID do Gateway: ",m("a.alt-link[target='_blank'][href='https://dashboard.pagar.me/#/transactions/"+c.gateway_id+"']",c.gateway_id)])]),m(".w-col.w-col-2",[m(".fontsize-smallest.lineheight-looser.fontweight-semibold",[m("span.fa.fa-circle"+a.stateClass())," "+c.state]),m(".fontsize-smallest.fontweight-semibold",[m("span.fa"+a.paymentMethodClass())," ",m("a.link-hidden[href='#']",c.payment_method)]),a.paymentDetails()?m.component(adminApp.PaymentBadge,{contribution:c}):""])]),m("a.w-inline-block.arrow-admin.fa.fa-chevron-down.fontcolor-secondary[data-ix='show-admin-cont-result'][href='javascript:void(0);']",{onclick:a.displayDetailBox.toggle}),m.component(adminApp.ToggleDiv,{display:a.displayDetailBox,content:m.component(adminApp.AdminDetail,{contribution:c})})])}},adminApp.AdminList={controller:function(a){!a.vm.collection().length&&a.vm.firstPage&&a.vm.firstPage().then(null,function(a){adminApp.error(a.message)})},view:function(a,b){return m(".w-section.section",[m(".w-container",[m(".w-row.u-marginbottom-20",[m(".w-col.w-col-9",[m(".fontsize-base",[m("span.fontweight-semibold",b.vm.total())," apoios encontrados"])])]),m("#admin-contributions-list.w-container",[b.vm.collection().map(function(a,b){return m.component(adminApp.AdminItem,{contribution:a,index:b})}),m(".w-section.section",[m(".w-container",[m(".w-row",[m(".w-col.w-col-2.w-col-push-5",[b.vm.isLoading()?loader():m("button#load-more.btn.btn-medium.btn-terciary",{onclick:b.vm.nextPage},"Carregar mais")])])])])])])])}},adminApp.filterDateRange={view:function(a,b){return m(".w-col.w-col-3.w-col-small-6",[m('label.fontsize-smaller[for="'+b.index+'"]',b.label),m(".w-row",[m(".w-col.w-col-5.w-col-small-5.w-col-tiny-5",[m('input.w-input.text-field.positive[id="'+b.index+'"][type="text"]',{onchange:m.withAttr("value",b.first),value:b.first()})]),m(".w-col.w-col-2.w-col-small-2.w-col-tiny-2",[m(".fontsize-smaller.u-text-center.lineheight-looser","e")]),m(".w-col.w-col-5.w-col-small-5.w-col-tiny-5",[m('input.w-input.text-field.positive[type="text"]',{onchange:m.withAttr("value",b.last),value:b.last()})])])])}},adminApp.filterDropdown={view:function(a,b){return m(".w-col.w-col-3.w-col-small-6",[m('label.fontsize-smaller[for="'+b.index+'"]',b.label),m('select.w-select.text-field.positive[id="'+b.index+'"]',{onchange:m.withAttr("value",b.vm),value:b.vm()},[_.map(b.options,function(a){return m('option[value="'+a.value+'"]',a.option)})])])}},adminApp.filterMain={view:function(a,b){return m(".w-row",[m(".w-col.w-col-10",[m('input.w-input.text-field.positive.medium[placeholder="'+b.placeholder+'"][type="text"]',{onchange:m.withAttr("value",b.vm),value:b.vm()})]),m(".w-col.w-col-2",[m('input#filter-btn.btn.btn-large.u-marginbottom-10[type="submit"][value="Buscar"]')])])}},adminApp.filterNumberRange={view:function(a,b){return m(".w-col.w-col-3.w-col-small-6",[m('label.fontsize-smaller[for="'+b.index+'"]',b.label),m(".w-row",[m(".w-col.w-col-5.w-col-small-5.w-col-tiny-5",[m('input.w-input.text-field.positive[id="'+b.index+'"][type="text"]',{onchange:m.withAttr("value",b.first),value:b.first()})]),m(".w-col.w-col-2.w-col-small-2.w-col-tiny-2",[m(".fontsize-smaller.u-text-center.lineheight-looser","e")]),m(".w-col.w-col-5.w-col-small-5.w-col-tiny-5",[m('input.w-input.text-field.positive[type="text"]',{onchange:m.withAttr("value",b.last),value:b.last()})])])])}},adminApp.AdminTransactionHistory={controller:function(a){var b=a.contribution,c=_.reduce([{date:b.paid_at,name:"Apoio confirmado"},{date:b.pending_refund_at,name:"Reembolso solicitado"},{date:b.refunded_at,name:"Estorno realizado"},{date:b.created_at,name:"Apoio criado"},{date:b.refused_at,name:"Apoio cancelado"}],function(a,b){return null!=b.date&&void 0!=b.date?(b.originalDate=b.date,b.date=momentify(b.date,"DD/MM/YYYY, HH:mm"),a.concat(b)):a},[]);this.orderedEvents=_.sortBy(c,"originalDate")},view:function(a,b){b.contribution;return m(".w-col.w-col-4",[m(".fontweight-semibold.fontsize-smaller.lineheight-tighter.u-marginbottom-20","Histórico da transação"),a.orderedEvents.map(function(a){return m(".w-row.fontsize-smallest.lineheight-looser.date-event",[m(".w-col.w-col-6",[m(".fontcolor-secondary",a.date)]),m(".w-col.w-col-6",[m("div",a.name)])])})])}},adminApp.AdminTransaction={view:function(a,b){var c=b.contribution;return m(".w-col.w-col-4",[m(".fontweight-semibold.fontsize-smaller.lineheight-tighter.u-marginbottom-20","Detalhes do apoio"),m(".fontsize-smallest.lineheight-looser",["Valor: R$"+formatNumber(c.value,2,3),m("br"),"Taxa: R$"+formatNumber(c.gateway_fee,2,3),m("br"),"Recompensa: "+formatNumber(c.reward_minimum_value,2,3),m("br"),"Anônimo: "+(c.anonymous?"Sim":"Não"),m("br"),"Id pagamento: "+c.gateway_id,m("br"),"Apoio: "+c.contribution_id,m("br"),"Chave: \n",m("br"),c.key,m("br"),"Meio: "+c.gateway,m("br"),"Operadora: "+(c.gateway_data&&c.gateway_data.acquirer_name),m("br"),function(){return c.is_second_slip?[m("a.link-hidden[href='#']","Boleto bancário")," ",m("span.badge","2a via")]:void 0}()])])}},adminApp.ToggleDiv={toggler:function(){return toggleProp("none","block")},controller:function(a){this.vm={display:a.display}},view:function(a,b){return m(".toggleDiv",{style:{transition:"all .1s ease-out",overflow:"hidden",display:a.vm.display()}},[b.content])}};