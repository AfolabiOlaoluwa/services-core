/*
    A Mithril.js plugin to authenticate requests against PostgREST
    Copyright (c) 2007 - 2015 Diogo Biazus
    Licensed under the MIT license (http://digitalbush.com/projects/masked-input-plugin/#license)
    Version: 1.0.0
*/
var adminApp=window.adminApp={models:{}},momentify=function(a,b){return b=b||"DD/MM/YYYY",a?moment(a).format(b):"no date"},momentFromString=function(a,b){var c=moment(a,b||"DD/MM/YYYY");return c.isValid()?c:moment(a)},generateFormatNumber=function(a,b){return function(c,d,e){if(null==c||void 0==c)return null;var f="\\d(?=(\\d{"+(e||3)+"})+"+(d>0?"\\D":"$")+")",g=c.toFixed(Math.max(0,~~d));return(b?g.replace(".",b):g).replace(new RegExp(f,"g"),"$&"+(a||","))}},formatNumber=generateFormatNumber(".",","),ContributionDetail=m.postgrest.model("contribution_details",["id","contribution_id","user_id","project_id","reward_id","payment_id","permalink","project_name","project_img","user_name","user_profile_img","email","key","value","installments","installment_value","state","anonymous","payer_email","gateway","gateway_id","gateway_fee","gateway_data","payment_method","project_state","has_rewards","pending_at","paid_at","refused_at","reward_minimum_value","pending_refund_at","refunded_at","created_at","is_second_slip"]);adminApp.models.ContributionDetail=ContributionDetail,adminApp.AdminContributions={controller:function(){var a=this.vm=adminApp.AdminContributions.VM;error=this.error=m.prop(),this.filterContributions=function(b){a.filter(b).then(null,function(a){error(a.message)})}},view:function(a){return[m.component(adminApp.AdminContributionsFilter,{onFilter:a.filterContributions}),m(".w-section.section",[m(".w-container",[m(".w-row.u-marginbottom-20",[m(".w-col.w-col-9",[m(".fontsize-base",[m("span.fontweight-semibold",a.vm.total())," apoios encontrados"])])]),a.error()?m(".card.card-error.u-radius.fontweight-bold",a.error()):m.component(adminApp.AdminContributionsList,{contributions:a.vm.collection})])]),m(".w-section.section",[m(".w-container",[m(".w-row",[m(".w-col.w-col-5"),m(".w-col.w-col-2",[a.vm.isLoading()?m("img[alt='Loader'][src='/assets/catarse_bootstrap/loader-eff2ad1eeb09a19c9afb5b143e1dd62b.gif']"):m("button#load-more.btn.btn-medium.btn-terciary",{onclick:a.vm.nextPage},"Carregar mais")]),m(".w-col.w-col-5")])])])]}},adminApp.AdminContributionsFilter={controller:function(a){var b=this.vm=adminApp.AdminContributionsFilter.VM;this.filter=function(){return a.onFilter(b.parameters()),!1},this.displayFilters=adminApp.ToggleDiv.toggleProp("none","block"),a&&this.filter()},view:function(a,b){return m("#admin-contributions-filter.w-section.page-header",[m(".w-container",[m(".fontsize-larger.u-text-center.u-marginbottom-30","Apoios"),m(".w-form",[m("form[data-name='Email Form'][id='email-form'][name='email-form']",{onsubmit:a.filter},[m(".w-row.u-marginbottom-20",[m(".w-col.w-col-10",[m("input.w-input.text-field.positive.medium[id='field'][name='field'][placeholder='Busque por projeto, email, Ids do usuário e do apoio...'][type='text']",{onchange:m.withAttr("value",a.vm.full_text_index),value:a.vm.full_text_index()}),m("a.fontsize-smallest.link-hidden-light[data-ix='admin-filter'][href='#']",{onclick:a.displayFilters.toggle},"Filtros avançados  >")]),m(".w-col.w-col-2",[m("input#filter-btn.btn.btn-large.u-marginbottom-10[type='submit'][href='#'][value='Buscar']")])]),m.component(adminApp.ToggleDiv,{display:a.displayFilters,content:m("#advanced-search.w-row.admin-filters",[m(".w-col.w-col-3.w-col-small-6",[m("label.fontsize-smaller[for='field-3']","Com o estado"),m("select.w-select.text-field.positive[id='field-3'][name='field-3']",{onchange:m.withAttr("value",a.vm.state),value:a.vm.state()},[m("option[value='']","Qualquer um"),m("option[value='pending']","pending"),m("option[value='refused']","refused"),m("option[value='paid']","paid"),m("option[value='pending_refund']","pending_refund"),m("option[value='refunded']","refunded"),m("option[value='chargeback']","chargeback"),m("option[value='deleted']","deleted")])]),m(".w-col.w-col-3.w-col-small-6",[m("label.fontsize-smaller[for='field-8']","Gateway"),m("select.w-select.text-field.positive[data-name='Field 8'][id='field-8'][name='field-8']",{onchange:m.withAttr("value",a.vm.gateway),value:a.vm.gateway()},[m("option[value='']","Qualquer um"),m("option[value='Pagarme']","Pagarme"),m("option[value='MoIP']","MoIP"),m("option[value='PayPal']","PayPal"),m("option[value='Credits']","Créditos")])]),m(".w-col.w-col-3.w-col-small-6",[m("label.fontsize-smaller[for='field-6']","Valores entre"),m(".w-row",[m(".w-col.w-col-5.w-col-small-5.w-col-tiny-5",[m("input.w-input.text-field.positive[data-name='Field 5'][id='field-5'][name='field-5'][type='text']",{onchange:m.withAttr("value",a.vm.value.gte),value:a.vm.value.gte()})]),m(".w-col.w-col-2.w-col-small-2.w-col-tiny-2",[m(".fontsize-smaller.u-text-center.lineheight-looser","e")]),m(".w-col.w-col-5.w-col-small-5.w-col-tiny-5",[m("input.w-input.text-field.positive[data-name='Field 5'][id='field-5'][name='field-5'][type='text']",{onchange:m.withAttr("value",a.vm.value.lte),value:a.vm.value.lte()})])])]),m(".w-col.w-col-3.w-col-small-6",[m("label.fontsize-smaller[for='field-7']","Período do apoio"),m(".w-row",[m(".w-col.w-col-5.w-col-small-5.w-col-tiny-5",[m("input.w-input.text-field.positive[data-name='Field 5'][id='field-5'][name='field-5'][type='text']",{onchange:m.withAttr("value",a.vm.created_at.gte),value:a.vm.created_at.gte()})]),m(".w-col.w-col-2.w-col-small-2.w-col-tiny-2",[m(".fontsize-smaller.u-text-center.lineheight-looser","e")]),m(".w-col.w-col-5.w-col-small-5.w-col-tiny-5",[m("input.w-input.text-field.positive[data-name='Field 5'][id='field-5'][name='field-5'][type='text']",{onchange:m.withAttr("value",a.vm.created_at.lte),value:a.vm.created_at.lte()})])])])])})])])])])}};var vm=adminApp.AdminContributionsFilter.VM=m.postgrest.filtersVM({full_text_index:"@@",state:"eq",gateway:"eq",value:"between",created_at:"between"});vm.state(""),vm.gateway("Pagarme"),vm.created_at.lte.toFilter=function(){return momentFromString(this()).endOf("day").format()},vm.created_at.gte.toFilter=function(){return momentFromString(this()).format()},adminApp.AdminContributionsList={view:function(a,b){return m("#admin-contributions-list.w-container",[b.contributions().map(function(a){return m.component(adminApp.AdminContributionsListDetail,{contribution:a,key:a})})])}},adminApp.AdminContributionsListDetail={controller:function(a){this.contribution=a.contribution,this.contribution.user_profile_img=this.contribution.user_profile_img||"/assets/catarse_bootstrap/user.jpg",this.CSSsuccess=".text-success",this.CSSwaiting=".text-waiting",this.CSSerror=".text-error",this.paymentDetails=function(){switch(this.contribution.gateway=this.contribution.gateway.toLowerCase(),this.contribution.gateway){case"moip":return this.contribution.card_first_digits=this.contribution.gateway_data.cartao_bin,this.contribution.card_last_digits=this.contribution.gateway_data.cartao_final,this.contribution.card_brand=this.contribution.gateway_data.cartao_bandeira,this.contribution.installments=this.contribution.gateway_data.parcelas,!0;case"pagarme":return this.contribution.card_first_digits=this.contribution.gateway_data.card_first_digits,this.contribution.card_last_digits=this.contribution.gateway_data.card_last_digits,this.contribution.card_brand=this.contribution.gateway_data.card_brand,this.contribution.installments=this.contribution.gateway_data.installments,!0;default:return!1}},this.stateClass=function(){switch(this.contribution.state){case"paid":return this.CSSsuccess;case"refunded":return this.CSSsuccess;case"pending":return this.CSSwaiting;default:return this.CSSerror}},this.paymentMethodClass=function(){switch(this.contribution.payment_method){case"BoletoBancario":return".fa-barcode";case"CartaoDeCredito":return".fa-credit-card";default:return".fa-question"}},this.displayDetailBox=adminApp.ToggleDiv.toggleProp("none","block")},view:function(a,b){var c=a.contribution;return m(".w-clearfix.card.u-radius.u-marginbottom-20.results-admin-contributions",[m(".w-row",[m(".w-col.w-col-4",[m(".w-row",[m(".w-col.w-col-3.w-col-small-3.u-marginbottom-10",[m("img.user-avatar[src='"+c.user_profile_img+"']")]),m(".w-col.w-col-9.w-col-small-9",[m(".fontweight-semibold.fontsize-smaller.lineheight-tighter.u-marginbottom-10",c.user_name),m(".fontsize-smallest","Usuário: "+c.user_id),m(".fontsize-smallest.fontcolor-secondary","Catarse: "+c.email),m(".fontsize-smallest.fontcolor-secondary","Gateway: "+c.payer_email)])])]),m(".w-col.w-col-4",[m(".w-row",[m(".w-col.w-col-3.w-col-small-3.u-marginbottom-10",[m("img.thumb-project.u-radius[src="+c.project_img+"][width=50]")]),m(".w-col.w-col-9.w-col-small-9",[m(".fontweight-semibold.fontsize-smaller.lineheight-tighter.u-marginbottom-10",c.project_name),m(".fontsize-smallest.fontweight-semibold",c.project_state),m(".fontsize-smallest.fontcolor-secondary",momentify(c.project_online_date)+" a "+momentify(c.project_expires_at))])])]),m(".w-col.w-col-2",[m(".fontweight-semibold.lineheight-tighter.u-marginbottom-10.fontsize-small","R$"+c.value),m(".fontsize-smallest.fontcolor-secondary",momentify(c.paid_at,"DD/MM/YYYY hh:mm[h]")),m(".fontsize-smallest","ID do Gateway: "+c.gateway_id)]),m(".w-col.w-col-2",[m(".fontsize-smallest.lineheight-looser.fontweight-semibold",[m("span.fa.fa-circle"+a.stateClass())," "+c.state]),m(".fontsize-smallest.fontweight-semibold",[m("span.fa"+a.paymentMethodClass())," ",m("a.link-hidden[href='#']",c.payment_method)]),a.paymentDetails()?m.component(adminApp.AdminContributionsListPaymentDetail,{contribution:c}):""])]),m("a.w-inline-block.arrow-admin.fa.fa-chevron-down.fontcolor-secondary[data-ix='show-admin-cont-result'][href='javascript:void(0);']",{onclick:a.displayDetailBox.toggle}),m.component(adminApp.ToggleDiv,{display:a.displayDetailBox,content:m.component(adminApp.AdminContributionsListPaymentDetailBox,{contribution:c})})])}},adminApp.AdminContributionsListPaymentDetail={view:function(a,b){var c=b.contribution;return m(".fontsize-smallest.fontcolor-secondary.lineheight-tight",[function(){switch(c.payment_method.toLowerCase()){case"boletobancario":return m("span#boleto-detail","");case"cartaodecredito":return m("#creditcard-detail.fontsize-smallest.fontcolor-secondary.lineheight-tight",[c.card_first_digits+"******"+c.card_last_digits,m("br"),c.card_brand+" "+c.installments+"x"])}}()])}},adminApp.AdminContributionsListPaymentDetailBox={controller:function(a){var b=function(){return adminApp.ToggleDiv.toggleProp("none","block")};this.displayRequestRefundDropDown=b(),this.displayRefundDropDown=b(),this.displayTransferContributionDropDown=b(),this.displayChangeRewardDropDown=b(),this.displatAnonDropDown=b()},view:function(a,b){var c=b.contribution;return m("#admin-contribution-detail-box",[m(".divider.u-margintop-20.u-marginbottom-20"),m(".w-row.u-marginbottom-30.w-hidden",[m(".w-col.w-col-2",[m("button.btn.btn-small.btn-terciary",{onclick:a.displayRequestRefundDropDown.toggle},"Pedir reembolso"),m.component(adminApp.ToggleDiv,{display:a.displayRequestRefundDropDown,content:m(".dropdown-list.card.u-radius.dropdown-list-medium.zindex-10[data-ix='display-none-on-load'][id='transfer']",[m(".fontsize-smaller.fontweight-semibold.u-text-center.u-marginbottom-20","Quer efetuar o reembolso?"),m("a.btn.btn-small[href='#']","Solicitar reembolso")])})]),m(".w-col.w-col-2",[m("button.btn.btn-small.btn-terciary",{onclick:a.displayRefundDropDown.toggle},"Estornar"),m.component(adminApp.ToggleDiv,{display:a.displayRefundDropDown,content:m(".dropdown-list.card.u-radius.dropdown-list-medium.zindex-10",[m(".fontsize-smaller.fontweight-semibold.u-text-center.u-marginbottom-20","Quer efetuar o estorno?"),m("a.btn.btn-small[href='#']","Solicitar estorno")])})]),m(".w-col.w-col-2",[m("button.btn.btn-small.btn-terciary.btn-desactivated[href='#']","2a via")]),m(".w-col.w-col-2",[m("button.btn.btn-small.btn-terciary",{onclick:a.displayTransferContributionDropDown.toggle},"Transferir apoio"),m.component(adminApp.ToggleDiv,{display:a.displayTransferContributionDropDown,content:m(".dropdown-list.card.u-radius.dropdown-list-medium.zindex-10",[m(".w-form",[m("form[data-name='Email Form 4'][id='email-form-4'][name='email-form-4']",[m("label[for='name-2']","Id do novo apoiador:"),m("input.w-input.text-field[data-name='Name 2'][id='name-2'][name='name'][placeholder='ex: 129908'][type='text']"),m("input.w-button.btn.btn-small[data-wait='Please wait...'][type='submit'][value='Transferir']")])])])})]),m(".w-col.w-col-2",[m("button.btn.btn-small.btn-terciary",{onclick:a.displayChangeRewardDropDown.toggle},"Trocar recompensa"),m.component(adminApp.ToggleDiv,{display:a.displayChangeRewardDropDown,content:m(".dropdown-list.card.u-radius.dropdown-list-medium.zindex-10[data-ix='display-none-on-load'][id='transfer']",{style:{display:" none"}},[m(".w-form",[m("form[data-name='Email Form 4'][id='email-form-4'][name='email-form-4']",[m(".w-radio",[m("input.w-radio-input[data-name='Radio'][id='radio'][name='radio'][type='radio'][value='Radio']"),m("label.w-form-label[for='radio']","R$ 10")]),m(".w-radio",[m("input.w-radio-input[data-name='Radio 2'][id='radio'][name='radio-2'][type='radio'][value='Radio']"),m("label.w-form-label[for='radio']","R$ 10")]),m(".w-radio",[m("input.w-radio-input[data-name='Radio 2'][id='radio'][name='radio-2'][type='radio'][value='Radio']"),m("label.w-form-label[for='radio']","R$ 10")]),m(".w-radio",[m("input.w-radio-input[data-name='Radio 2'][id='radio'][name='radio-2'][type='radio'][value='Radio']"),m("label.w-form-label[for='radio']","R$ 10")]),m(".w-radio",[m("input.w-radio-input[data-name='Radio 2'][id='radio'][name='radio-2'][type='radio'][value='Radio']"),m("label.w-form-label[for='radio']","R$ 10")])])])])})]),m(".w-col.w-col-2",[m("button.btn.btn-small.btn-terciary",{onclick:a.displatAnonDropDown.toggle},"Anonimato"),m.component(adminApp.ToggleDiv,{display:a.displatAnonDropDown,content:m(".dropdown-list.card.u-radius.dropdown-list-medium.zindex-10",[m(".w-form",[m("form[data-name='Email Form 4'][id='email-form-4'][name='email-form-4']",[m(".w-radio",[m("input.w-radio-input[data-name='Radio'][id='radio'][name='radio'][type='radio'][value='Radio']"),m("label.w-form-label[for='radio']","Anônimo")]),m(".w-radio",[m("input.w-radio-input[data-name='Radio 2'][id='radio'][name='radio-2'][type='radio'][value='Radio']"),m("label.w-form-label[for='radio']","Público")])])])])})])]),m(".w-row.card.card-terciary.u-radius",[m.component(adminApp.AdminContributionsListPaymentDetailBoxDetailed,{contribution:c}),m.component(adminApp.AdminContributionsListPaymentDetailBoxHistory,{contribution:c}),m(".w-col.w-col-4")])])}},adminApp.AdminContributionsListPaymentDetailBoxDetailed={view:function(a,b){var c=b.contribution;return m(".w-col.w-col-4",[m(".fontweight-semibold.fontsize-smaller.lineheight-tighter.u-marginbottom-20","Detalhes do apoio"),m(".fontsize-smallest.lineheight-looser",["Valor: R$"+formatNumber(c.value,2,3),m("br"),"Taxa: R$"+formatNumber(c.gateway_fee,2,3),m("br"),"Recompensa: "+formatNumber(c.reward_minimum_value,2,3),m("br"),"Anônimo: "+(c.anonymous?"Sim":"Não"),m("br"),"Id pagamento: "+c.gateway_id,m("br"),"Apoio: "+c.contribution_id,m("br"),"Chave: \n",m("br"),c.key,m("br"),"Meio: "+c.gateway,m("br"),"Operadora: "+c.gateway_data.acquirer_name,m("br"),function(){return c.is_second_slip?[m("a.link-hidden[href='#']","Boleto bancário")," ",m("span.badge","2a via")]:void 0}()])])}},adminApp.AdminContributionsListPaymentDetailBoxHistory={controller:function(a){var b=a.contribution,c=_.reduce([{date:b.paid_at,name:"Apoio confirmado"},{date:b.pending_refund_at,name:"Reembolso solicitado"},{date:b.refunded_at,name:"Estorno realizado"},{date:b.created_at,name:"Apoio criado"},{date:b.refused_at,name:"Apoio cancelado"}],function(a,b){return null!=b.date&&void 0!=b.date?(b.originalDate=b.date,b.date=momentify(b.date,"DD/MM/YYYY, HH:mm"),a.concat(b)):a},[]);this.orderedEvents=_.sortBy(c,"originalDate")},view:function(a,b){b.contribution;return m(".w-col.w-col-4",[m(".fontweight-semibold.fontsize-smaller.lineheight-tighter.u-marginbottom-20","Histórico da transação"),a.orderedEvents.map(function(a){return m(".w-row.fontsize-smallest.lineheight-looser.date-event",[m(".w-col.w-col-6",[m(".fontcolor-secondary",a.date)]),m(".w-col.w-col-6",[m("div",a.name)])])})])}},adminApp.AdminContributions.VM=m.postgrest.paginationVM(adminApp.models.ContributionDetail.getPageWithToken),adminApp.ToggleDiv={toggleProp:function(a,b){var c=m.prop(a);return c.toggle=function(){c(c()===b?a:b)},c},controller:function(a){this.vm={display:a.display}},view:function(a,b){return m(".toggleDiv",{style:{transition:"all .1s ease-out",overflow:"hidden",display:a.vm.display()}},[b.content])}};