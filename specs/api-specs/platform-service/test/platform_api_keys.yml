---
- config:
  - testset: "Platform api"
- test:
  - name: "listing platform api keys"
  - url: "/api_keys"
  - headers: {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJyb2xlIjoicGxhdGZvcm1fdXNlciIsInVzZXJfaWQiOjk5OTl9.vqzoX2JmI5ZCKZNSCxeX-fns4p4x_r47gjD1qLYIC7Y', 'Content-Type': 'application/json'}
  - method: "GET"
  - expected_status: [200]
  - validators:
    - compare: {jsonpath_mini: "0.platform_id", comparator: "eq", expected: 9999}
    - compare: {jsonpath_mini: "0.token", comparator: "eq", expected: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJyb2xlIiA6ICJwbGF0Zm9ybV91c2VyIiwgInBsYXRmb3JtX3Rva2VuIiA6ICJhMjhiZTc2Ni1iYjM2LTQ4MjEtODJlYy03NjhkMjYzNGQ3OGIiLCAiZ2VuX2F0IiA6IDE1MDQxMzM0NDB9.30t56HzhKy8IvYRryWSXRePQlo3ClI5_fN3U-d-dV5A"}

- test:
  - name: "listing api keys without token"
  - url: "/api_keys"
  - method: "GET"
  - expected_status: [401]

- test:
  - name: "Creating new api key"
  - url: "/rpc/generate_api_key"
  - headers: {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJyb2xlIjoicGxhdGZvcm1fdXNlciIsInVzZXJfaWQiOjk5OTl9.vqzoX2JmI5ZCKZNSCxeX-fns4p4x_r47gjD1qLYIC7Y', 'Content-Type': 'application/json'}
  - method: "POST"
  - body: '{"platform_id": 9999}'
  - expected_status: [200]
  - validators:
    - compare: {jsonpath_mini: "0.platform_id", comparator: "eq", expected: 9999}
    - compare: {jsonpath_mini: "0.token", comparator: "regex", expected: ".*"}

- test:
  - name: "Creating new api key without key"
  - url: "/rpc/generate_api_key"
  - method: "POST"
  - body: '{"platform_id": 9999}'
  - expected_status: [404]

- test:
  - name: "Creating scoped_user using platform api key"
  - url: "/rpc/generate_scoped_user_key"
  - headers: {'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJyb2xlIiA6ICJwbGF0Zm9ybV91c2VyIiwgInBsYXRmb3JtX3Rva2VuIiA6ICJhMjhiZTc2Ni1iYjM2LTQ4MjEtODJlYy03NjhkMjYzNGQ3OGIiLCAiZ2VuX2F0IiA6IDE1MDQxMzM0NDB9.30t56HzhKy8IvYRryWSXRePQlo3ClI5_fN3U-d-dV5A', 'Content-Type': 'application/json'}
  - method: "POST"
  - body: '{"user_id": 12}'
  - expected_status: [200]
  - validators:
    - compare: {jsonpath_mini: "0.token", comparator: "regex", expected: ".*"}

- test:
  - name: "Creating scoped_user using none api key"
  - url: "/rpc/generate_scoped_user_key"
  - method: "POST"
  - body: '{"user_id": 12}'
  - expected_status: [404]
